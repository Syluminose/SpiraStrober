name: Build
on:
  push:
    branches:
      - Rust
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          printf "[package]\nname=\"r\"\nversion=\"0.1.0\"\nedition=\"2021\"\n[lib]\ncrate-type=[\"cdylib\"]\n[profile.release]\nopt-level=\"z\"\nlto=true\npanic=\"abort\"\ncodegen-units=1">Cargo.toml;mkdir -p src
          cat<<'F'>src/lib.rs
          #![no_std]
          #[panic_handler]fn p(_:&core::panic::PanicInfo)->!{loop{}}
          static A:[f32;24]=[0.78539816,0.4636476,0.24497866,0.12435499,0.06241881,0.03123983,0.01562373,0.00781234,0.00390623,0.00195312,0.00097656,0.00048828,0.00024414,0.00012207,0.00006103,0.00003052,0.00001526,0.00000763,0.00000381,0.00000191,0.00000095,0.00000048,0.00000024,0.00000012];
          #[no_mangle]pub extern "C" fn Wx(x:f32)->f32{
          let mut v=x-(x as i32) as f32;if v<0.{v+=1.}
          let mut t=v*6.2831853-3.1415927;let mut x=0.60725293;let mut y=0.0;let mut s=1.0;
          if t.abs()>1.5707963{t=if t>0.{t-3.1415927}else{t+3.1415927};x=-x;}
          let mut d=1.0;for i in 0..24{
          let z=if t>0.{1.}else{-1.};
          let nx=x-z*y*d;y=y+z*x*d;x=nx;t-=z*A[i];d*=0.5;}y}
          #[no_mangle]pub extern "C" fn Li(a:f32,b:f32,t:f32,d:f32)->f32{a+(b-a)*t/d}
          #[no_mangle]pub extern "C" fn In(a:f32,b:f32,t:f32,d:f32)->f32{a*t+(b-a)*t*t/(2.*d)}
          #[no_mangle]pub extern "C" fn Sl(a:f32,b:f32,d:f32)->f32{(b-a)/d}
          #[no_mangle]pub extern "C" fn Mx(a:f32,b:f32,d:f32)->f32{d*(a+b)/2.}
          F
          rustup target add wasm32-unknown-unknown
          cargo build --release --target wasm32-unknown-unknown
          printf "const WW='$(base64 -w 0 target/wasm32-unknown-unknown/release/r.wasm)';" > lib.js
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: Rust
          commit_message: "Optimized CORDIC Rust"
