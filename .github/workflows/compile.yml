name: Build
on:
  push:
    branches:
      - Rust
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          printf "[package]\nname=\"r\"\nversion=\"0.1.0\"\nedition=\"2021\"\n[lib]\ncrate-type=[\"cdylib\"]\n[profile.release]\nopt-level=\"z\"\nlto=true\npanic=\"abort\"\ncodegen-units=1">Cargo.toml;mkdir -p src
          cat<<'F'>src/lib.rs
          #![no_std]
          #[panic_handler]fn p(_:&core::panic::PanicInfo)->!{loop{}}
          #[no_mangle]pub extern "C" fn Li(a:f32,b:f32,t:f32,d:f32)->f32{a+(b-a)*t/d}
          #[no_mangle]pub extern "C" fn In(a:f32,b:f32,t:f32,d:f32)->f32{a*t+(b-a)*t*t/(2.*d)}
          #[no_mangle]pub extern "C" fn Sl(a:f32,b:f32,d:f32)->f32{(b-a)/d}
          #[no_mangle]pub extern "C" fn Mx(a:f32,b:f32,d:f32)->f32{d*(a+b)/2.}
          #[no_mangle]pub unsafe extern "C" fn Ph(s:*const f32,h:*mut f32,n:usize){
            let mut c=[0.;6];let mut p=[0.;6];let mut a=[0.;6];
            for i in 0..n-1{
              let curr=s.add(i*90);let next=s.add((i+1)*90);let dt=*curr;
              let out=h.add(i*18);
              for k in 0..6{
                let o=k*15;
                let f0=(*curr.add(o+4)/0.001f32.max(*curr.add(o+3))).powf(1./ *curr.add(o+5))/6.283185;
                let f1=(*next.add(o+4)/0.001f32.max(*next.add(o+3))).powf(1./ *next.add(o+5))/6.283185;
                *out.add(k)=c[k];*out.add(k+6)=p[k];*out.add(k+12)=a[k];
                c[k]+=dt*(f0+f1)/2.;
                p[k]+=dt*(*curr.add(o+1)+*next.add(o+1))/2.;
                a[k]+=dt*(*curr.add(o+8)+*next.add(o+8))/2.;
              }}}F
          rustup target add wasm32-unknown-unknown
          cargo build --release --target wasm32-unknown-unknown
          mv target/wasm32-unknown-unknown/release/r.wasm lib.js
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update lib.js (wasm)"
          file_pattern: lib.js
