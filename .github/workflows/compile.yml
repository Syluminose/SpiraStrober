name: Build
on:
  push:
    branches:
      - Rust
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          printf "[package]\nname=\"r\"\nversion=\"0.1.0\"\nedition=\"2021\"\n[lib]\ncrate-type=[\"cdylib\"]\n[profile.release]\nopt-level=\"z\"\nlto=true\npanic=\"abort\"\ncodegen-units=1">Cargo.toml;mkdir -p src
          cat<<'F'>src/lib.rs
          #![no_std]
          #[panic_handler]fn p(_:&core::panic::PanicInfo)->!{loop{}}
          #[no_mangle]pub extern "C" fn Li(a:f32,b:f32,t:f32,d:f32)->f32{a+(b-a)*t/d}
          #[no_mangle]pub extern "C" fn In(a:f32,b:f32,t:f32,d:f32)->f32{a*t+(b-a)*t*t/(2.*d)}
          #[no_mangle]pub extern "C" fn Sl(a:f32,b:f32,d:f32)->f32{(b-a)/d}
          #[no_mangle]pub extern "C" fn Mx(a:f32,b:f32,d:f32)->f32{d*(a+b)/2.}
          #[no_mangle]pub unsafe extern "C" fn Gh(s:*const f32,h:*mut f32,n:usize){
            let (s,h)= (core::slice::from_raw_parts(s,n*90),core::slice::from_raw_parts_mut(h,n*18));
            for i in 0..n-1 {
              let (curr,next,h_curr,h_next) = (&s[i*90..],&s[(i+1)*90..],i*18,(i+1)*18);
              let dt = curr[0];
              for k in 0..6 {
                let o = k*15;
                h[h_next+k] = h[h_curr+k] + Mx(Fn(curr[o+4],curr[o+3],curr[o+5]),Fn(next[o+4],next[o+3],next[o+5]),dt);
                h[h_next+6+k] = h[h_curr+6+k] + Mx(curr[o+1],next[o+1],dt);
                h[h_next+12+k] = h[h_curr+12+k] + Mx(curr[o+8],next[o+8],dt);
              }
            }
          }
          fn Fn(a:f32,b:f32,h:f32)->f32{ (if a<0.001 {0.001} else {a}/if b<0.001 {0.001} else {b}).powf(1./h)/6.2831853 }
          F
          rustup target add wasm32-unknown-unknown
          cargo build --release --target wasm32-unknown-unknown
          printf "const WW='$(base64 -w 0 target/wasm32-unknown-unknown/release/r.wasm)';" > lib.js
