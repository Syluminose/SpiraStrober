name: Compile Rust
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Force Create Project
        run: |
          echo '[package]' > Cargo.toml
          echo 'name = "r_lib"' >> Cargo.toml
          echo 'version = "0.1.1"' >> Cargo.toml
          echo 'edition = "2021"' >> Cargo.toml
          echo '[lib]' >> Cargo.toml
          echo 'crate-type = ["cdylib"]' >> Cargo.toml
          echo '[profile.release]' >> Cargo.toml
          echo 'opt-level = "z"' >> Cargo.toml
          echo 'lto = true' >> Cargo.toml
          echo 'codegen-units = 1' >> Cargo.toml
          echo 'panic = "abort"' >> Cargo.toml
          
          mkdir -p src
          cat << 'EOF' > src/lib.rs
          // Désactive la librairie standard pour un binaire ultra-léger
          #![no_std]
          use core::panic::PanicInfo;

          #[panic_handler]
          fn panic(_info: &PanicInfo) -> ! { loop {} }

          // Fonctions d'interpolation de base
          #[no_mangle] 
          pub extern "C" fn Li(a:f32, b:f32, t:f32, d:f32) -> f32 { a + (b - a) * t / d }

          #[no_mangle] 
          pub extern "C" fn In(a:f32, b:f32, t:f32, d:f32) -> f32 { a * t + (b - a) * t * t / (2.0 * d) }

          #[no_mangle] 
          pub extern "C" fn Sl(a:f32, b:f32, d:f32) -> f32 { (b - a) / d }

          // Optimisation : Forme d'onde complexe (an en JS)
          // Évite les allers-retours JS/WASM pour les sinus imbriqués
          #[no_mangle]
          pub extern "C" fn An(v:f32, k:f32, h:f32) -> f32 {
              let s = (v + k * v.sin()).sin();
              ((s * 0.5) + 0.5).powf(h)
          }

          // Optimisation : Calcul de fréquence normalisée (Fn en JS)
          #[no_mangle]
          pub extern "C" fn Fn_w(a:f32, b:f32, h:f32) -> f32 {
              let b_safe = if b < 0.001 { 0.001 } else { b };
              (a / b_safe).powf(1.0 / h) / 6.283185307
          }

          // Optimisation : Calcul du gain/densité (df en JS)
          #[no_mangle]
          pub extern "C" fn Df(s3:f32, s4:f32, s5:f32) -> f32 {
              s4.powf(1.0 / s5) * s3.powf(1.0 - 1.0 / s5)
          }
          EOF

      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Build
        run: cargo build --target wasm32-unknown-unknown --release

      - name: Convert to Base64 and Export
        run: |
          WASM_B64=$(base64 -w 0 target/wasm32-unknown-unknown/release/r_lib.wasm)
          echo "window.r_wasm_b64 = '$WASM_B64';" > r_lib.js
