name: Compile Rust
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Force Create Project
        run: |
          # Reconstruction du Cargo.toml avec optimisations de taille
          echo '[package]' > Cargo.toml
          echo 'name = "r_lib"' >> Cargo.toml
          echo 'version = "0.1.0"' >> Cargo.toml
          echo 'edition = "2021"' >> Cargo.toml
          echo '[lib]' >> Cargo.toml
          echo 'crate-type = ["cdylib"]' >> Cargo.toml
          echo '[profile.release]' >> Cargo.toml
          echo 'opt-level = "z"' >> Cargo.toml
          echo 'lto = true' >> Cargo.toml
          echo 'codegen-units = 1' >> Cargo.toml
          
          # Injection des fonctions mathÃ©matiques d'origine
          mkdir -p src
          echo '#[no_mangle] pub extern "C" fn Li(a: f32, b: f32, t: f32, d: f32) -> f32 { a + (b - a) * t / d }' > src/lib.rs
          echo '#[no_mangle] pub extern "C" fn In(a: f32, b: f32, t: f32, d: f32) -> f32 { a * t + (b - a) * t * t / (2.0 * d) }' >> src/lib.rs
          echo '#[no_mangle] pub extern "C" fn Sl(a: f32, b: f32, d: f32) -> f32 { (b - a) / d }' >> src/lib.rs

      - name: Build
        run: |
          rustup target add wasm32-unknown-unknown
          cargo build --target wasm32-unknown-unknown --release

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: r-wasm
          path: target/wasm32-unknown-unknown/release/r_lib.wasm
